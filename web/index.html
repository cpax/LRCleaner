<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LRCleaner - LogRhythm Log Source Management</title>
    <link rel="stylesheet" href="/static/style.css?v=2">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Collapsible Sidebar -->
    <div id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h1><i class="fas fa-broom"></i> <span class="sidebar-text">LRCleaner</span></h1>
            <p class="sidebar-text">LogRhythm Log Source Management Tool</p>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-section">
                <h3><i class="fas fa-tools"></i> <span class="sidebar-text">Operations</span></h3>
                <ul>
                    <li><a href="#" id="analyzeNav" class="nav-link active" title="Analyze">
                        <i class="fas fa-chart-line"></i> <span class="sidebar-text">Analyze</span>
                    </a></li>
                    <li><a href="#" id="rollbackNav" class="nav-link" title="Rollback">
                        <i class="fas fa-undo"></i> <span class="sidebar-text">Rollback</span>
                    </a></li>
                </ul>
            </div>
            <div class="nav-section">
                <ul>
                    <li><a href="#" id="settingsNav" class="nav-link" title="Settings">
                        <i class="fas fa-cog"></i> <span class="sidebar-text">Settings</span>
                    </a></li>
                </ul>
            </div>
        </nav>
        <button id="sidebarToggle" class="sidebar-toggle" title="Toggle Sidebar">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <!-- Main Content Area -->
    <div id="mainContent" class="main-content">
        <div class="container">

        <!-- Settings Section -->
        <div id="settingsSection" class="settings-section" style="display: none;">
            <!-- Configuration Section -->
            <div class="card">
                <h2><i class="fas fa-sliders-h"></i> Configuration</h2>
                <form id="configForm">
                    <div class="form-group">
                        <label for="hostname">LogRhythm Hostname:</label>
                        <input type="text" id="hostname" name="hostname" placeholder="lr-server.company.com" required>
                    </div>
                    <div class="form-group">
                        <label for="apiKey">API Key:</label>
                        <input type="password" id="apiKey" name="apiKey" placeholder="Enter your LogRhythm API key" required>
                    </div>
                    <div class="form-group">
                        <label for="port">Port:</label>
                        <input type="number" id="port" name="port" value="8501" min="1" max="65535">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Configuration
                        </button>
                        <button type="button" class="btn btn-info" id="testConnectionBtn">
                            <i class="fas fa-plug"></i> Test Connection
                        </button>
                    </div>
                </form>
                <div id="configStatus" class="status-message"></div>
            </div>

            <!-- Database Backup Section -->
            <div class="card">
                <h2><i class="fas fa-database"></i> Database Backup</h2>
                <div class="backup-content">
                    <p>Before performing any retirement operations, it's recommended to create a backup of your LogRhythm database.</p>
                    <div class="backup-instructions">
                        <h3>Manual Database Backup Steps:</h3>
                        <ol>
                            <li>Log in to the system that is your Platform Manager</li>
                            <li>Open SQL Server Management Studio and log in with an account that has administrative privileges (e.g., <code>sa</code>)</li>
                            <li>Expand the "Databases" node and select <code>LogRhythmEMDB</code></li>
                            <li>Right-click <code>LogRhythmEMDB</code>, select <strong>Tasks</strong>, then click <strong>Back Up...</strong></li>
                            <li>The "Back Up Database - LogRhythmEMDB" window appears</li>
                            <li>In the <strong>Source</strong> section, set the backup type to <strong>Full</strong></li>
                            <li>In the <strong>Backup set</strong> section, you may change the file name and description if desired</li>
                            <li>In the <strong>Destination</strong> section, ensure "Back up to: Disk" is selected. Click <strong>Add</strong> to specify a file or device for the backup</li>
                            <li>Click <strong>OK</strong> to start the backup</li>
                            <li>When the backup is complete, close SQL Server Management Studio</li>
                        </ol>
                    </div>
                    <div class="backup-actions">
                        <button type="button" class="btn btn-success" id="backupAcknowledgeBtn">
                            <i class="fas fa-check"></i> I Have Backed Up the Database
                        </button>
                        <button type="button" class="btn btn-warning" id="backupSkipBtn">
                            <i class="fas fa-exclamation-triangle"></i> Skip Backup (Not Recommended)
                        </button>
                    </div>
                    <div id="backupStatus" class="status-message"></div>
                </div>
            </div>

            <!-- Rollback Configuration Section -->
            <div class="card">
                <h2><i class="fas fa-undo"></i> Rollback Configuration</h2>
                <div class="rollback-config-content">
                    <p>Configure rollback settings for retirement operations. Rollback allows you to undo changes made by LRCleaner.</p>
                    <form id="rollbackConfigForm">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="rollbackEnabled" name="rollbackEnabled" checked>
                                <span class="checkmark"></span>
                                Enable Rollback Functionality
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="rollbackRetentionDays">Retention Days:</label>
                            <input type="number" id="rollbackRetentionDays" name="rollbackRetentionDays" value="30" min="1" max="365" required>
                            <small>Number of days to keep rollback data (minimum 1 day)</small>
                        </div>
                        <div class="form-group">
                            <label for="rollbackMaxPoints">Maximum Rollback Points:</label>
                            <input type="number" id="rollbackMaxPoints" name="rollbackMaxPoints" value="10" min="1" max="50" required>
                            <small>Maximum number of rollback points to maintain</small>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="rollbackAutoBackup" name="rollbackAutoBackup" checked>
                                <span class="checkmark"></span>
                                Auto Backup Before Rollback
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="rollbackBackupLocation">Rollback Storage Location:</label>
                            <input type="text" id="rollbackBackupLocation" name="rollbackBackupLocation" value="./rollback/" placeholder="./rollback/">
                            <small>Directory to store rollback data files</small>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Rollback Settings
                            </button>
                        </div>
                    </form>
                    <div id="rollbackConfigStatus" class="status-message"></div>
                </div>
            </div>
        </div>

        <!-- Analysis Section (default view) -->
        <div id="analysisSection" class="analysis-section">

        <!-- Control Section -->
        <section class="control-section">
            <div class="card">
                <div class="control-row">
                    <div class="date-picker-group">
                        <label for="mainDate">Last Log Message Date:</label>
                        <input type="date" id="mainDate" name="mainDate" required>
                    </div>
                    <div class="button-group">
                        <button id="applyModeBtn" class="btn btn-success" disabled>
                            <i class="fas fa-play"></i> Go
                        </button>
                        <button id="applyBtn" class="btn btn-danger" disabled>
                            <i class="fas fa-check"></i> Apply
                        </button>
                        <button id="clearBtn" class="btn btn-secondary">
                            <i class="fas fa-trash"></i> Clear Results
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Test Mode Modal -->
        <div id="testModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-search"></i> Test Mode</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="testDate">Last Log Message Date:</label>
                        <input type="date" id="testDate" name="testDate" required>
                    </div>
                    <button id="startTestBtn" class="btn btn-success">
                        <i class="fas fa-play"></i> Start Analysis
                    </button>
                </div>
            </div>
        </div>


        <!-- SQL Backup Modal -->
        <div id="backupModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-database"></i> Database Backup</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="backup-info">
                        <p><strong>Backup Target:</strong> LogRhythmEMDB</p>
                        <p><strong>User:</strong> logrhythmadmin</p>
                        <p><strong>Purpose:</strong> Create a backup before retiring log sources</p>
                    </div>
                    <div class="form-group">
                        <label for="backupPassword">Password for logrhythmadmin:</label>
                        <input type="password" id="backupPassword" name="backupPassword" placeholder="Enter password" required>
                    </div>
                    <div class="form-group">
                        <label for="backupLocation">Backup Location (optional):</label>
                        <input type="text" id="backupLocation" name="backupLocation" placeholder="Default: C:\LogRhythm\Backup" value="C:\LogRhythm\Backup">
                    </div>
                    <div class="modal-actions">
                        <button id="executeBackupBtn" class="btn btn-primary">
                            <i class="fas fa-download"></i> Execute Backup
                        </button>
                        <button id="cancelBackupBtn" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Apply Configuration Modal -->
        <div id="applyConfigModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-cog"></i> Apply Configuration</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="applyDate">Last Log Message Date:</label>
                        <input type="date" id="applyDate" name="applyDate" required>
                    </div>
                    <div class="modal-actions">
                        <button id="startApplyBtn" class="btn btn-warning">
                            <i class="fas fa-play"></i> Analyze Hosts
                        </button>
                        <button id="backToBackupBtn" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Backup
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Host Selection Modal -->
        <div id="hostSelectionModal" class="modal">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h3><i class="fas fa-list-check"></i> Select Hosts for Retirement</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="host-selection-controls">
                        <div class="select-all-controls">
                            <label class="checkbox-label">
                                <input type="checkbox" id="selectAllHosts">
                                <span class="checkmark"></span>
                                Select All Recommended Hosts
                            </label>
                            <button id="selectAllBtn" class="btn btn-secondary btn-sm">
                                <i class="fas fa-check-double"></i> Select All
                            </button>
                            <button id="deselectAllBtn" class="btn btn-secondary btn-sm">
                                <i class="fas fa-times"></i> Deselect All
                            </button>
                        </div>
                        <div class="host-summary" id="hostSummaryModal1"></div>
                    </div>
                    <div class="host-list" id="hostList">
                        <!-- Hosts will be populated here -->
                    </div>
                    <div class="modal-actions">
                        <button id="executeRetirementBtnModal1" class="btn btn-warning" disabled>
                            <i class="fas fa-check"></i> Execute Retirement
                        </button>
                        <button id="cancelRetirementBtnModal1" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Collection Host Selection Modal -->
        <div id="collectionHostModal" class="modal">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h3><i class="fas fa-server"></i> Collection Host Retirement</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="collection-host-info">
                        <div class="info-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="info-content">
                            <h4>Collection Host Analysis Complete</h4>
                            <p>The following collection hosts have been identified as candidates for retirement:</p>
                            <ul>
                                <li>Unreachable collection hosts with zero log sources</li>
                                <li>Collection hosts with zero log sources (regardless of connectivity)</li>
                            </ul>
                        </div>
                    </div>
                    <div class="collection-host-selection-controls">
                        <div class="select-all-controls">
                            <label class="checkbox-label">
                                <input type="checkbox" id="selectAllCollectionHosts">
                                <span class="checkmark"></span>
                                Select All Recommended Collection Hosts
                            </label>
                            <button id="selectAllCollectionHostsBtn" class="btn btn-secondary btn-sm">
                                <i class="fas fa-check-double"></i> Select All
                            </button>
                            <button id="deselectAllCollectionHostsBtn" class="btn btn-secondary btn-sm">
                                <i class="fas fa-times"></i> Deselect All
                            </button>
                        </div>
                        <div class="collection-host-summary" id="collectionHostSummary"></div>
                    </div>
                    <div class="collection-host-list" id="collectionHostList">
                        <!-- Collection hosts will be populated here -->
                    </div>
                    <div class="modal-actions">
                        <button id="executeCollectionHostRetirementBtn" class="btn btn-warning" disabled>
                            <i class="fas fa-check"></i> Retire Collection Hosts
                        </button>
                        <button id="cancelCollectionHostRetirementBtn" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Congratulations Modal -->
        <div id="congratulationsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header success-header">
                    <h3><i class="fas fa-trophy"></i> Congratulations!</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="success-content">
                        <div class="success-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h4>Retirement Process Completed Successfully!</h4>
                        <div class="retirement-summary" id="retirementSummary">
                            <!-- Summary will be populated here -->
                        </div>
                        <div class="action-buttons">
                            <button id="exportReportBtn" class="btn btn-primary">
                                <i class="fas fa-file-text"></i> Export Report
                            </button>
                            <button id="closeCongratulationsBtn" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

            </div>
        </div>

        <!-- Host Selection Modal -->
        <div id="hostSelectionModal" class="modal">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h3><i class="fas fa-list-check"></i> Select Hosts for Retirement</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="backup-warning">
                        <div class="warning-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="warning-content">
                            <h4>Important: Backup Recommendation</h4>
                            <p>Before proceeding with retirement, it is strongly recommended to backup the LogRhythmEMDB database:</p>
                            <ol>
                                <li>Stop LogRhythm services</li>
                                <li>Backup the LogRhythmEMDB database</li>
                                <li>Document the backup location and timestamp</li>
                                <li>Restart LogRhythm services</li>
                            </ol>
                            <p><strong>This backup will allow you to restore the system if needed.</strong></p>
                        </div>
                    </div>
                    <div class="host-selection-controls">
                        <div class="select-all-controls">
                            <label class="checkbox-label">
                                <input type="checkbox" id="selectAllHosts">
                                <span class="checkmark"></span>
                                Select All Recommended Hosts
                            </label>
                            <button id="selectAllBtn" class="btn btn-secondary btn-sm">
                                <i class="fas fa-check-double"></i> Select All
                            </button>
                            <button id="deselectAllBtn" class="btn btn-secondary btn-sm">
                                <i class="fas fa-times"></i> Deselect All
                            </button>
                        </div>
                        <div class="host-summary" id="hostSummaryModal2"></div>
                    </div>
                    
                    <!-- Filter Controls -->
                    <div class="results-controls">
                        <div class="search-box">
                            <input type="text" id="hostSearchInput" placeholder="Search hosts...">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="filter-box">
                            <select id="hostPingFilter">
                                <option value="">All Ping Results</option>
                                <option value="Success">Success</option>
                                <option value="Failure">Failure</option>
                            </select>
                        </div>
                        <div class="filter-box">
                            <select id="hostLogSourceTypeFilter">
                                <option value="">All Log Source Types</option>
                            </select>
                        </div>
                        <div class="filter-box">
                            <select id="hostLogSourceNameFilter">
                                <option value="">All Log Source Names</option>
                            </select>
                        </div>
                        <div class="clear-filters-box">
                            <button id="clearHostFiltersBtn" class="btn btn-secondary btn-sm">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                        </div>
                    </div>
                    
                    <div class="host-list" id="hostList">
                        <!-- Hosts will be populated here -->
                    </div>
                    <div class="modal-actions">
                        <button id="executeRetirementBtnModal2" class="btn btn-warning" disabled>
                            <i class="fas fa-check"></i> Execute Retirement
                        </button>
                        <button id="cancelRetirementBtnModal2" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Congratulations Modal -->
        <div id="congratulationsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header success-header">
                    <h3><i class="fas fa-trophy"></i> Congratulations!</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="success-content">
                        <div class="success-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h4>Retirement Process Completed Successfully!</h4>
                        <div class="retirement-summary" id="retirementSummary">
                            <!-- Summary will be populated here -->
                        </div>
                        <div class="action-buttons">
                            <button id="exportPDFBtn" class="btn btn-primary">
                                <i class="fas fa-file-pdf"></i> Export PDF Report
                            </button>
                            <button id="undoChangesBtn" class="btn btn-warning">
                                <i class="fas fa-undo"></i> Undo Changes
                            </button>
                            <button id="closeCongratulationsBtn" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Section -->
        <section class="progress-section" id="progressSection" style="display: none;">
            <div class="card">
                <h2><i class="fas fa-tasks"></i> Progress</h2>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill"></div>
                </div>
                <div id="progressText" class="progress-text">Ready</div>
                <div id="jobStatus" class="job-status"></div>
            </div>
        </section>

        <!-- Results Section -->
        <section class="results-section">
            <div class="card">
                <h2><i class="fas fa-table"></i> Results</h2>
                <div class="results-controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search results...">
                    </div>
                    <div class="filter-box">
                        <select id="pingFilter">
                            <option value="">All Ping Results</option>
                            <option value="Success">Success</option>
                            <option value="Failure">Failure</option>
                            <option value="Unknown">Unknown</option>
                        </select>
                    </div>
                    <div class="filter-box">
                        <select id="logSourceTypeFilter">
                            <option value="">All Log Source Types</option>
                        </select>
                    </div>
                    <div class="filter-box">
                        <select id="logSourceNameFilter">
                            <option value="">All Log Source Names</option>
                        </select>
                    </div>
                    <div class="clear-filters-box">
                        <button id="clearFiltersBtn" class="btn btn-secondary btn-sm">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                    </div>
                </div>
                
                <!-- Host Selection Controls (shown only in apply mode) -->
                <div id="hostSelectionControls" class="host-selection-controls" style="display: none;">
                    <div class="host-summary" id="hostSummaryResults"></div>
                    <div class="select-all-controls">
                        <button id="selectVisibleBtn" class="btn btn-secondary btn-sm">
                            <i class="fas fa-eye"></i> Select Visible Hosts
                        </button>
                        <button id="selectAllHostsBtn" class="btn btn-secondary btn-sm">
                            <i class="fas fa-check-double"></i> Select All
                        </button>
                        <button id="deselectAllHostsBtn" class="btn btn-secondary btn-sm">
                            <i class="fas fa-times"></i> Deselect All
                        </button>
                    </div>
                    <div class="host-selection-actions">
                        <button id="executeRetirementBtn" class="btn btn-warning" disabled>
                            <i class="fas fa-check"></i> Execute Retirement
                        </button>
                        <button id="cancelRetirementBtn" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="resultsTable">
                        <tbody id="resultsBody">
                            <tr>
                                <td colspan="5" class="no-results">No results yet. Run Test Mode to analyze log sources.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="resultsSummary" class="results-summary"></div>
                
                <!-- Export Button -->
                <div class="export-section" style="margin-top: 20px; text-align: center;">
                    <button id="exportBtn" class="btn btn-primary" disabled>
                        <i class="fas fa-download"></i> Export Results
                    </button>
                </div>
            </div>
        </section>
        </div> <!-- End analysis section -->

        <!-- Rollback Section -->
        <div id="rollbackSection" class="rollback-section" style="display: none;">
            <div class="card">
                <h2><i class="fas fa-undo"></i> Rollback History</h2>
                <div class="rollback-info">
                    <p>View and manage rollback points for retirement operations. Rollback allows you to undo changes made by LRCleaner.</p>
                </div>
                
                <!-- Rollback Controls -->
                <div class="rollback-controls">
                    <button id="refreshRollbackBtn" class="btn btn-primary">
                        <i class="fas fa-refresh"></i> Refresh History
                    </button>
                    <button id="cleanupRollbackBtn" class="btn btn-secondary">
                        <i class="fas fa-trash"></i> Cleanup Old Rollbacks
                    </button>
                </div>
                
                <!-- Rollback History List -->
                <div class="rollback-history" id="rollbackHistory">
                    <div class="loading-message">
                        <i class="fas fa-spinner fa-spin"></i> Loading rollback history...
                    </div>
                </div>
            </div>
        </div>

        </div> <!-- End container -->
    </div> <!-- End main content -->

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Processing...</p>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <script src="/static/script.js?v=2"></script>
</body>
</html>
